{% extends "layout.html" %}
{% from "release_list.html" import release_list, rating_widget %}

{% block title %}{{ release.title }} [{{release.date[:4]}}] - {{ release.get_artists()[0].name }} {{ super() }}{% endblock %}

{% set accent_color_1, accent_color_2, accent_color_3 = release.get_palette() %}

{% block content %}
<section class="album">
	<div class="album-main">
		<header>
            <h1>
                {{ release.title }}
                {% set average_rating = release.get_rating_stats().average %}
                <span id="average-rating-section" style="{{ '' if average_rating else 'display: none;' }}">
                    <span id="average-rating">{{ "%.1f" % average_rating if average_rating else '' }}</span>
                </span>
            </h1>
			<h2 class="byline">
            {% for artist in release.get_artists() %}
                <span class="author"><a href={{ url_for("artist_page", slug=artist.slug) }}>{{ artist.name }}</a></span>
            {% endfor %}
                <time>{{ release.date[:4] }}</time>
            </h2>
		</header>
		
		<ol class="tracks">
        {% set sides, runtime, track_no = release.get_tracks() %}
        {% for tracks in sides %}
            {% for track in tracks %}
    			<li>
                    {{ track.title }}
                    {% if track.runtime %} <time>{{ track.runtime }}</time> {% endif %}
                </li>
            {% endfor %}
        {% endfor %}
        {% if runtime and track_no != 1 %}
            <li class="total clearfix"><time>{{ runtime }}</time></li>
        {% endif %}
		</ol>
		
        <ol class="action inline unselectable">
            {% set active_actions = user.get_active_actions(release.id) if user else [] %}
            <li><a class="clickable {{ 'selected' if 'list' in active_actions else '' }}"
                   name="list" href=# data-release-id={{ release.id }}>
                <i class="material-icons">playlist_add</i>Will listen to
            </a></li>
            <li><a class="clickable {{ 'selected' if 'listen' in active_actions else '' }}"
                   name="listen" href=# data-release-id={{ release.id }}>
                <i class="material-icons">headset</i>Listened to
            </a></li>
            <li><a class="clickable {{ 'selected' if 'share' in active_actions else '' }}"
                   name="share" href=# data-release-id={{ release.id }}>
                <i class="material-icons">share</i>Share
            </a></li>
        </ol>
	    
        {% set ratings = user.get_ratings() if user else {} %}
        {{ rating_widget(release, ratings[release.id] if release.id in ratings, None) }}
	</div>
    <div class="album-cover">
        {% if release.thumb_art_url %}
            <a href="{{ release.full_art_url }}"><img src="{{ release.thumb_art_url }}"/></a><br/>
        {% endif %}
        <div class="next-albums">
            {% for artist, previous, next in release.get_next_releaseses() %}
                {% if previous or next %}
                    {% if loop.index != 1 %}
                        <div>By <a href={{ url_for("artist_page", slug=artist.slug) }}>{{ artist.name }}</a>:</div>
                    {% endif %}
                    {% if previous %}
                        <a href={{ previous.url }} class="previous">&larr; {{ previous.title }} [{{ previous.date[:4] }}]</a>
                    {% endif %}
                    {% if next %}
                        <a href={{ next.url }} class="next">{{ next.title }} [{{ next.date[:4] }}] &rarr;</a>
                    {% endif %}
                    <br/>
                {% endif %}
            {% endfor %}
        </div>
    </div>
</section>

{% for artist in release.get_artists() %}
<section>
	<header>
        <h3 id="more-from"><em>More from</em></h3>
        <h1>{{ artist.name }}</h1>
    </header>
	
	{{ release_list(artist.get_releases() | selectattr("release_type", "equalto", "Album") | rejectattr("id", "equalto", release.id) | sort(attribute="date")) }} 
    
    {% set description = artist.get_description() %}
	<p>{{ description | safe if description else "" }}</p>
</section>
{% endfor %}
{% endblock %}
