{% extends "layout.html" %}
{% from "macros.html" import full_and_friendly_datetime %}
{% from "release_list.html" import release_list, release_grid %}

{% block title %}{{ that_user.name }} {{ super() }}{% endblock %}

{% set chart_js = True %}

{% block content %}

<section class="clearfix">
    <div class="chart">
        <canvas id="user-chart" width="400" height="200"></canvas>
        <form>
            <label><input type="radio" name="chart-select" value="rating-counts" checked="true">Ratings</label>
            <label><input type="radio" name="chart-select" value="year-counts">Years</label>
        </form>
    </div>

    <header><h1>{{ that_user.name }}</h1></header>

    <p>
        {% set rated_no = that_user.get_ratings() | length %}
        Joined {{ full_and_friendly_datetime(that_user.creation) }}<br/>
        Rated {{ n_things(rated_no, "release") }}
    </p>
    
    {% if user and that_user.id != user.id %}
        {% set following_since = user.get_follow(that_user.id) %}
        <p>
        {% if following_since %}
            Started following {{ full_and_friendly_datetime(following_since) }}<br/>
            <a href={{ url_for_user(that_user) + "?action=unfollow" }}>Unfollow</a>
        {% else %}
            <a href={{ url_for_user(that_user) + "?action=follow" }}>Follow</a>
        {% endif %}
        </p>
    {% endif %}
</section>

{% set ratings, listened = that_user.get_releases_actioned() %}
{% set by_rating = group_by_rating(ratings) %}
{% set user_datasets = get_user_datasets(ratings) %}

{% set rating_description = that_user.get_rating_descriptions() %}

<script>
var userDatasets = {{ json_dumps(user_datasets) | safe }};
</script>

{% set editable = 'editable' if that_user.id == user.id else '' %}

<div class="grids-list">
{% for n in range(8, 0, -1) %}
    <section><div>
        <header><h1>{{ n }}
            {% if rating_description[n] %} &ndash;
            &ldquo;<span class="{{ editable }} rating-description single-line"
                         data-rating={{ n }}>{{ rating_description[n] }}</span>&rdquo;
             {% if editable %}<i class="material-icons edit-sign">edit</i>{% endif %}
            {% endif %}
        </h1></header>
        {{ release_grid(sort_by_artist(by_rating[n]), user, "small", artist_not_date=True) }}
    </div></section>
{% endfor %}
    <section><div>
        <header><h1>Listened but unrated</h1></header>
        {{ release_grid(sort_by_artist(listened), user, "small", artist_not_date=True) }}
    </div></section>
</div>

{% endblock %}
